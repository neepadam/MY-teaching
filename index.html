<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mid Yorkshire Anaesthetics and Critical Care Teaching Programme</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-white min-h-screen text-gray-800 font-sans">

  <!-- Fixed Header -->
  <header class="fixed top-0 left-0 w-full bg-white shadow-md z-50 px-6 py-4 text-center">
    <h1 class="text-xl sm:text-3xl md:text-4xl font-extrabold text-indigo-800">
      Mid Yorkshire Anaesthetics & Critical Care Teaching
    </h1>
    <p class="text-sm text-gray-500 mt-1">Weekly education programme for trainees across Yorkshire</p>
  </header>

  <!-- Main Content -->
  <main class="pt-32 px-4 sm:px-8 pb-16 max-w-6xl mx-auto">

    <!-- Buttons Section -->
    <section class="flex flex-wrap justify-center gap-6 mb-12">
      <a href="https://docs.google.com/spreadsheets/d/1sDtcdb8EzoWcLlKoXMwgguJr4o-4JjMpWHtKBZtfq6I/edit?usp=sharing" target="_blank"
         class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl shadow-md transition duration-300 text-lg font-semibold">
        ðŸ“… Sign Up to Teach
      </a>
      <a href="https://forms.gle/YZ1YL8WSWW5vSHpY8" target="_blank"
         class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl shadow-md transition duration-300 text-lg font-semibold">
        ðŸ§¾ Generate Certificate
      </a>
    </section>

    <!-- Teaching Sessions -->
    <div id="content" class="flex flex-wrap gap-6 justify-center"></div>
  </main>

  <!-- JavaScript -->
  <script>
    const API_URL = "https://api.sheetbest.com/sheets/7b5d00ef-5595-4217-be52-91b9a20921a8";
    const contentDiv = document.getElementById("content");
    let cachedGroupedData = {};

    const teamsLinks = {
      Tuesday: "https://teams.microsoft.com/l/tuesday-link",
      Wednesday: "https://teams.microsoft.com/l/wednesday-link",
      Thursday: "https://teams.microsoft.com/l/thursday-link"
    };

    function formatDateDisplay(date) {
      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = day === 0 ? -6 : 1 - day;
      d.setDate(d.getDate() + diff);
      return new Date(d.setHours(0, 0, 0, 0));
    }

    function getDayOfWeek(date) {
      return date.toLocaleDateString('en-US', { weekday: 'long' });
    }

    function groupByWeek(data, baseMonday) {
      const grouped = {};
      const baseWeekStart = getMonday(baseMonday);
      const nextWeekStart = new Date(baseWeekStart);
      nextWeekStart.setDate(nextWeekStart.getDate() + 7);

      data.forEach(entry => {
        if (!entry.date || !entry.name || !entry.topic) return;
        const d = new Date(entry.date);
        if (isNaN(d)) return;

        const entryMonday = getMonday(d);
        if (entryMonday.getTime() !== baseWeekStart.getTime() && entryMonday.getTime() !== nextWeekStart.getTime()) return;

        const weekKey = formatDate(entryMonday);
        if (!grouped[weekKey]) grouped[weekKey] = [];

        grouped[weekKey].push({
          date: formatDate(d),
          dayOfWeek: getDayOfWeek(d),
          name: entry.name,
          topic: entry.topic
        });
      });

      return grouped;
    }

    async function init() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        contentDiv.innerHTML = '';

        const today = new Date();
        const baseMonday = getMonday(today);
        const groupedData = groupByWeek(data, baseMonday);
        cachedGroupedData = groupedData;

        const weekKeys = Object.keys(groupedData).sort();
        if (weekKeys.length === 0) {
          contentDiv.innerHTML = '<p class="text-center text-gray-700">No teaching sessions scheduled for this week or next.</p>';
          return;
        }

        weekKeys.forEach(weekStart => {
          const sessions = groupedData[weekStart];
          const weekStartDate = new Date(weekStart);

          const section = document.createElement('section');
          section.className = 'bg-white border-l-4 border-blue-500 rounded-xl p-4 shadow-lg w-full max-w-2xl';

          const heading = document.createElement('h2');
          heading.className = 'text-2xl font-semibold text-indigo-700 mb-4';
          heading.textContent = `Week commencing ${formatDateDisplay(weekStartDate)}`;
          section.appendChild(heading);

          const box = document.createElement('div');
          box.className = 'space-y-4';

          sessions.sort((a,b) => new Date(a.date) - new Date(b.date));
          sessions.forEach(({dayOfWeek, name, topic}) => {
            const entry = document.createElement('div');
            entry.className = 'p-4 bg-blue-50 border border-blue-200 rounded-md shadow';

            const teamsLink = teamsLinks[dayOfWeek];
            const linkButton = teamsLink ? `<a href="${teamsLink}" target="_blank" class="mt-2 inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Join ${dayOfWeek} Session</a>` : '';

            entry.innerHTML = `
              <p class="font-bold text-indigo-900 text-lg">${dayOfWeek}</p>
              <p class="text-gray-800"><strong>Topic:</strong> ${topic}</p>
              <p class="text-gray-600"><strong>Presenter:</strong> ${name}</p>
              ${linkButton}
            `;

            box.appendChild(entry);
          });

          section.appendChild(box);
          contentDiv.appendChild(section);
        });

      } catch (e) {
        contentDiv.innerHTML = '<p class="text-red-600 text-center">Failed to load teaching sessions.</p>';
        console.error(e);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>

</body>
</html>
